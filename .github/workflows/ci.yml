name: HRB Jackpot Coin â€” Build & Artifacts (Linux + Windows)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-linux:
    name: Build (Linux)
    runs-on: ubuntu-latest
    steps:
      # --- Checkout + submodules (needed for secp256k1, leveldb, etc.)
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          lfs: "false"
      - name: Mark repo safe
        run: git config --global --add safe.directory '*'

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libtool autotools-dev automake pkg-config bsdmainutils python3 \
            libssl-dev libevent-dev libboost-system-dev libboost-filesystem-dev libboost-chrono-dev \
            libboost-test-dev libboost-thread-dev libminiupnpc-dev \
            qtbase5-dev qttools5-dev qttools5-dev-tools \
            zip

      - name: Autotools bootstrap
        run: |
          chmod +x autogen.sh || true
          ./autogen.sh || true

      - name: Configure (try GUI, fallback headless)
        run: |
          ./configure --with-gui=qt || ./configure --without-gui || (test -f config.log && tail -n +1 config.log; false)

      - name: Build (verbose)
        run: make -j"$(nproc)" V=1

      - name: Package Linux
        run: |
          mkdir -p dist/linux
          [ -f src/hrbjackpotcoind ] && cp src/hrbjackpotcoind dist/linux/ || true
          [ -f src/hrb-cli ] && cp src/hrb-cli dist/linux/ || true
          [ -f src/hrb-tx ] && cp src/hrb-tx dist/linux/ || true
          [ -f src/qt/hrbjackpotcoin-qt ] && cp src/qt/hrbjackpotcoin-qt dist/linux/ || true
          tar -C dist -czf hrbjackpotcoin-linux.tar.gz linux

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: hrbjackpotcoin-linux
          path: hrbjackpotcoin-linux.tar.gz
          if-no-files-found: error

  build-windows:
    name: Build (Windows, cross-compile on Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          lfs: "false"
      - name: Mark repo safe
        run: git config --global --add safe.directory '*'

      - name: Install cross toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libtool autotools-dev automake pkg-config bsdmainutils python3 curl git \
            g++-mingw-w64-x86-64 mingw-w64 mingw-w64-tools cmake zip

      - name: Prepare depends
        run: |
          mkdir -p depends/sources depends/work

      - name: Build depends (Windows)
        run: |
          make -C depends HOST=x86_64-w64-mingw32 -j"$(nproc)"
        timeout-minutes: 60

      - name: Autotools bootstrap
        run: |
          chmod +x autogen.sh || true
          ./autogen.sh || true

      - name: Configure (Windows, headless)
        run: |
          CONFIG_SITE=$PWD/depends/x86_64-w64-mingw32/share/config.site \
          ./configure --host=x86_64-w64-mingw32 --prefix=/ --without-gui || (test -f config.log && tail -n +1 config.log; false)

      - name: Build (Windows, verbose)
        run: make -j"$(nproc)" V=1

      - name: Package Windows
        run: |
          mkdir -p dist/windows
          [ -f src/hrbjackpotcoind.exe ] && cp src/hrbjackpotcoind.exe dist/windows/ || true
          [ -f src/hrb-cli.exe ] && cp src/hrb-cli.exe dist/windows/ || true
          [ -f src/hrb-tx.exe ] && cp src/hrb-tx.exe dist/windows/ || true
          (cd dist && zip -r ../hrbjackpotcoin-windows.zip windows)

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: hrbjackpotcoin-windows
          path: hrbjackpotcoin-windows.zip
          if-no-files-found: error
